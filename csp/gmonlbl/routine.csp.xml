<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<CSP name="routine.csp" application="/csp/user/gmonlbl/"><![CDATA[
<!DOCTYPE html>

<html>
  <head>
    <title> Cache Server Page </title>

    <!-- CSS Initializing -->
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="css/custom.css">
    <link rel="stylesheet" type="text/css" href="css/non-responsive.css">

  </head>

  <body>

    <!-- main-container for "sticky" footer -->
    <div class="main-container">

      <!-- Navbar section start-->
      <div class="navbar navbar-default" role="navigation">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">MONLBL Viewer</a>
          <ul class="nav navbar-nav">
            <li><button class="btn navbar-btn btn-default" id="btnBack" type="button">Index</button></li>
          </ul>
        </div>
      </div>
      <!-- Navbar section end-->

      <!-- Details table section start -->
      <div class="tbl-container">
        <table id="tblRoutineDetails" class="table table-bordered table-hover table-condensed">
          <thead>
            <tr>
              <th class="numbering-cell center-align">#</th>
              <th class="number-cell asc center-align">RtnLine</th>
              <th class="number-cell asc center-align">Time</th>
              <th class="number-cell asc center-align">Total Time</th> 
              <th class="code-cell asc center-align">Code</th>
              <th class="calls-cell">Calls</th>
            </tr>
          </thead>
          <tbody id="tblRoutineDetailsBody">
          </tbody>
        </table>
      </div>
      <!-- Details table section end -->

      <!-- push for "sticky" footer -->
      <div class="push"></div>

    </div>

    <!-- Footer section start -->
    <div class="footer">Â© 2014 SS23, InterSystems</div>
    <!-- Footer section end -->


    <!-- Scripts -->
    <script language="javascript" src="lib/jquery-1.11.1.min.js"></script>
    <script language="javascript" src="lib/bootstrap.min.js"></script>
    <script language="javascript" src="lib/custom.js"></script>

    <script language="javascript">

    // variable declaration
    var
    // current routine
    routine,
    // JSON accured from server response
    jsonData;

    routine = '#(..EscapeHTML( %request.Get("name",1) ))#';

    $(document).ready(function () {

      jsonData = #server(..FetchRoutineData( routine ))#;

      if ( jsonData ) {
        jsonData = $.parseJSON( jsonData );

        // On page load
        (function() {
          // variable declaration
          var
            // table row
            tr,
            // array of dropdown list elements
            options,
            // table cell
            td,
            // counters
            i, j,
            // <ul> imlements dropdown
            dropdown,
            // <li> implementsdropdown head
            dropdownEl,
            // <ul> implements body of dropdown list
            list,
            // element of options array
            opt,
            // <li> element implemnts element of dropdown body
            el,
            // <a> implements a h-link wraps the el
            link,
            // regular expression for routine name
            rRtn = /\^[\w_%\.]+/i,
            // array of 'exec' method results
            rtnArr,
            optContent;

          $('#tblRoutineDetails tbody tr').remove();

          for ( i = 0; i < jsonData.length; i++ ) {

            tr = $( '<tr/>' );
            tr.append( '<td class=' + '\"center-valign center-align rownums\"' + '>' + '<a name = "' + +(i+1) + '">' + '</td>' );
            tr.append( '<td class=' + '\"center-valign right-align\"' + '>' + jsonData[ i ].RtnLine + '</td>' );
            tr.append( '<td class=' + '\"center-valign right-align\"' + '>' + jsonData[ i ].Time + '</td>' );
            tr.append( '<td class=' + '\"center-valign right-align\"' + '>' + jsonData[ i ].TotalTime + '</td>' );
            tr.append( '<td>' + jsonData[ i ].Line + '</td>' );

            options = '';
            options = jsonData[ i ].Calls.split( '|' );

            td = document.createElement( 'td' );

            if ( (options.length) && (options[ 0 ] !== '') ) {

              dropdown = document.createElement( 'ul' );
              $(dropdown).addClass( 'rtn-list-dropdown' );

              dropdownEl = document.createElement( 'li' );
              dropdownEl.textContent = '>>'

              list = document.createElement( 'ul' );
              $(list).addClass( 'rtn-list' );

              for ( j = 0; j < options.length; j++ ) {

                opt = options[ j ];

                el = document.createElement( 'li' );

                $(el).addClass( 'rtn-list-el' );
                
                link = document.createElement( 'a' );
                
                optContent = opt.split("~");

                if ( optContent.length > 1) {
                  link.textContent = optContent[ 0 ] + ":: " + optContent[ 2 ]; 
                }
                else {
                  link.textContent = optContent
                }
      
                if ( optContent.length === 1) {
                    rtnArr = rRtn.exec( optContent[ 0 ] );
                    
                    if ( rtnArr !== null ) {
                      optContent[ 0 ] = rtnArr[ 0 ];
                    }
                } 

                if (optContent.length === 1 ) {
                  link.href = 'routine.csp?name=' + optContent[ 0 ];
                }
                else {
                  link.href = 'routine.csp?name=' + optContent[ 0 ] + "#" + (optContent[ 1 ] - 1);
                }

                el.appendChild( link );
                list.appendChild( el );
              }

              dropdownEl.appendChild( list );
              dropdown.appendChild( dropdownEl );
              td.appendChild( dropdown );
            }

            tr.append(td);

            $('#tblRoutineDetails').append( tr );
          };
        })();

      }
      else {
        alert("There is no INT code.");  
      }

    });

    $(document).ready(function () {
      $('.rtn-list-dropdown li').on('click',
        function () {
          //show submenu
          
          if ( $('ul', this).hasClass('active') ) {
            $('ul', this).toggleClass('active');
          }
          else {
            $('.rtn-list').removeClass('active');
            $('ul', this).toggleClass('active');
          }
       });
    });
    
    // Heartbeat
    $(document).everyTime(300000, function(i) {
      '#(..EscapeHTML( %request.Get("name",1) ))#'
    });

    // Back button handler
    $('#btnBack').on('click', function() {
        window.location.href = 'index.csp';
    });

  </script>


   <script language="Cache" method="FetchRoutineData" arguments="rtnName:%String" returntype="%String">
    kill totalData

    set stream = ##class(%Stream.TmpCharacter).%New()
    set outStream = ##class(%Stream.TmpCharacter).%New()
    set colorer = ##class(%SyntaxColor).%New()
    set visitor = ##class(GMONLBL.Visitor).%New()

    // find routine
    set rtnNum = $zutil( 84, 16 )
    set found = 0

    for rtn = 1 : 1 : rtnNum {
      if ( rtnName = $zutil( 84, 16, 2, rtn ) ) {
        set found = 1
        quit
      }
    }

    if ( 'found ) {
      return ""
    }

    // collect routine data
    set lines = $zutil( 84, 16, 1, rtn )

    if (lines = 0 ) {
      return ""
    }

    for line = 0 : 1 : ( lines - 1 ) {
      kill map
      set list = ""

      set data = $zutil( 84, 16, 3, line, 33 )
      set list = list_$listbuild( data )

      // line time
      set data = $zutil( 84, 16, 3, line, 50 )
      // convert clock/CPU time to seconds
      set data = $select( data = 0:0, 1:$fnumber( data / 1000000, "", 6 ) )
      set list = list_$listbuild( data )

      set localTime = data

      // total time
      set data = $zutil( 84, 16, 3, line, 51 )
      // convert clock/CPU time to seconds
      set data = $select( data = 0:0, 1:$fnumber( data / 1000000, "", 6) )
      set list = list_$listbuild( data )

      set totalTime = data

      do stream.Clear()
      do outStream.Clear()

      set codeLine = $$LINE^%R( rtnName, line + 1 )

      set visitor.Routines = ""
      set visitor.Classes = ""
      set visitor.Methods = ""
      set rtnNamesList = ""

      // Missing lines without routine calls
      if ( totalTime > localTime ) {

        set tree = ##class(%Compiler.COS.ParseTree).Parse( codeLine, ,.sc )

        if ( 'sc ) {
          set tree = ""
        }
        
        kill classList
        kill methodList
        kill rtnNamesList
        
        if ( tree '= "" ) {

          do tree.accept( visitor )

          set routines = visitor.Routines
          
          set rtnNamesList = ""
          
          set classList = visitor.Classes
          set methodList = visitor.Methods
                 
          if ( $listlength( routines ) ) {
            for k = 1 : 1 : $listlength( routines ) {
              
              set routine = $piece( $list( routines, k ), "^", 2 )
              set method = $piece( $list( routines, k ), "^", 1 )
              
              if ( method '= "" ) {
                do ##class(%Studio.Debugger).INTLine( routine_".MAC", method, 0, .intName, .intLine)

                if ( intName '= "" ) {
                  set rtnNamesList = rtnNamesList_intName_"~"_intLine_"~"_method_"|"
                } 
              }
              else {
                if ( routine'= "" ) {
                  set rtnNamesList = rtnNamesList_routine_"|"
                }
              }
            } 
          }            
          
          if ( $listlength( classList ) ) {
            for k = 1 : 1 : $listlength( classList ) {
              do ##class(%Studio.Debugger).INTLine( $li( classList, k)_".CLS", $li( methodList, k ), 0, .intName, .intLine)

              if ( intName '= "" ) {
                set rtnNamesList = rtnNamesList_intName_"~"_intLine_"~"_$li( methodList, k )_"|"
              } 
            } 
          }          
            
          if ( rtnNamesList '= "" ) {
            set rtnNamesList = $extract( rtnNamesList, 1, *-1 )
          }

        }

      }

      do stream.WriteLine( codeLine )
      do colorer.Color( stream, outStream )

      set codeLine = $replace( outStream.ReadLine(), "\", "\\" )
      set codeLine = $replace( codeLine, $char( 09 ), "\t" )
      set codeLine = $replace( codeLine, """", "\""" )

      set list = list_$listbuild( codeLine )
      set list = list_$listbuild( rtnNamesList )

      set totalData( line + 1 ) = list
    }


    // Assambling JSON
    set json = "["

    for line = 1 : 1 : lines {
      set list = totalData( line )
      set json = json_"{""RtnLine"":"""_$li( list, 1 )_
                      """,""Time"":"""_$li( list, 2 )_
                      """,""TotalTime"":"""_$li( list, 3 )_
                      """,""Line"":"""_$li( list, 4 )_
                      """,""Calls"":"""_$li( list, 5 )_
                      """},"
    }

    if ( json '= "[" ) {
      set json = $extract( json, 1, *-1 )_"]"
    }
    else {
      set json = ""
    }

    return json

  </script>

  </body>

</html>]]></CSP>
</Export>
